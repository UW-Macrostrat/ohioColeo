<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>The Ohio Coleopterists</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content=""/>
    <meta name="author" content="John J Czaplewski"/>

    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.no-icons.min.css" rel="stylesheet"/>
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"/>
    <link href="/lib/datepicker.css" rel="stylesheet"/>
    <!--<link href="/lib/leaflet.css" rel="stylesheet" />-->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6/leaflet.css" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
    <style>
    label {
      display: inline-table;
      margin-top: 5px;
      margin-right: 10px;
    }
    .modal {
      left:3%;
      width:92%;
      margin-left: 0;
    }
    .modal-body {
      max-height: 1000px;
    }
    .locationMethod {
      text-align: center;
    }
    .locationMethod:hover {
      color:white;
      background: rgba(86, 156, 183, 1);
      cursor: pointer;
    }
    #selectinputmethod {
      color:white;
    }
    .modalBack:hover {
      cursor: pointer;
    }
    .close {
      font-size: 16px;
      line-height: 16px;
    }
    #map1 {
      height:379px;
    }
    #map2 {
      height:379px;
    }
    #map3 {
      height:379px;
    }
    .mapInstructions {
      background-color:#fff;
      padding:8px;
    }
    #map1SelectDone {
      float:right;
    }
    #map3SelectDone {
      float:right;
    }
    #map2SelectDone {
      margin-left:10px;
    }
    #viewOnMap {
      margin-left: 10px;
    }
    .table th, .table td {
      vertical-align: middle;
    }
    .totals {
      position: relative;
      top:6px;
      margin-right: 25px;
    }
    #dropTarget {
      width: 100px;
      border-radius: 6px;
      height: 100px;
      border: 1px #ccc solid;
      padding: 10px;
      display:inline-block;
      cursor: pointer;
      text-align: center;
    }
    #uploadPlus {
      position: relative;
      top:12px;
    }
    #uploadText {
      font-size: 11px;
      top:12px;
      position: relative;
      line-height: 0;
    }
    .imagesToUpload {
      margin-top:-76px;
      margin-left:10px;
      margin-right:10px;
    }
    .addNewText {
      display:inline;
      margin-right:12px;
      margin-left:20px;
      font-size:12px;
    }
    .leaflet-control-layers-expanded {
      padding: 6px 10px 0px 10px;
    }
    input[type="radio"], input[type="checkbox"] {
      margin: -3px 0 0;
    }
    .control-group {
      display:inline;
    }
    #degreesLat {
      width:38px;
    }
    #minutesLat {
      width:70px;
      margin-left: 4px;
    }
    #degreesLng {
      width:38px;
    }
    #minutesLng {
      width: 70px;
      margin-left: 4px;
    }
    </style>
    
  </head>

  <body>
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12">
          <h3>Occurence Upload Form</h3>
          <a href="/beetles/stats">See upload stats <i class="icon-arrow-right"></i></a>
          <form method='POST' enctype='multipart/form-data' action='/beetles/upload' id='uploadForm'  onSubmit="return validate()">

            <table id="uploadTable" class="table table-striped">
              <tr class='taxon'>
                <th class='right'>Taxon*:</th>
                <td>
                  <div class="control-group" id="familyGroup">
                    <input placeholder='Family (required)' type='text' size='22' name='family' data-provide='typeahead'/>
                  </div>
                  <input type='hidden' name='pbdb_family_no' value=''/>
                  <input placeholder='Common name' type='text' size='20' name='common_name'/> <br>
                  
                  <input placeholder='Genus' type='text' size='22' name='genus' data-provide='typeahead'/>
                  <input type='hidden' name='pbdb_genus_no' value='' />
                  <input placeholder='Species' type='text' size='20' name='species' data-provide='typeahead'/>
                  <input type='hidden' name='pbdb_species_no' value='' />
                  <input placeholder='Author' type='text' size='20' name='author'/>
                  
                </td>
              </tr>
              <tr class='determiner'>
                <th class='right'>Determiner:</th>
                <td>
                  <select class="medium" name='determiner'>
                    <option value="" selected>&nbsp;</option>
                    {{#people}}
                    <option value="{{id}}">{{name}}</option>
                    {{/people}}
                  </select>
                  <input type='hidden' name='determiner_full'/>
                  <p class="addNewText">or enter a new one:</p><input type='text' size='12' name='new_determiner_first_name' placeholder='First Name'/><input type='text' size='12' name='new_determiner_last_name' placeholder='Last Name'/>
                </td>
              </tr>
              <tr class="date" id="collection_date_row">
                <th class='right'>Collection Date*:</th>
                <td>
                  <select class="span1" name="daystart">
                    <option value="" selected>&nbsp;</option>
                  </select>
                  <select class="span2" name="monthstart">
                    <option value="" selected>&nbsp;</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                  </select>
                  <select class="span1" name="yearstart">
                    <option value="" selected>&nbsp;</option>
                  </select>

                  <label> to </label>

                  <select class="span1" name="dayend"><option value="" selected>&nbsp;</option></select>
                  <select class="span2" name="monthend">
                    <option value="" selected>&nbsp;</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                  </select>
                  <select class="span1" name="yearend"><option value="" selected>&nbsp;</option></select>
<!--
                  <div class="input-append date" id="collection_date_start">
                    <input type='text' class='span6' name='collection_date_start'><span class="add-on"><i class="icon-th"></i></span>
                  </div>

                  <div class="input-append date" id="collection_date_end" style="margin-left:-61px;">
                    <label>to </label>
                      <input type='text' class='span5' name='collection_date_end'><span class="add-on"><i class="icon-th"></i></span>
                  </div>
-->
                </td>
              </tr>
              <tr class="location">
                <th class='right'>Location collected/observed*:</th>
                <td>
                  <div id="selectedLocation" style="display: inline;margin-right: 10px;"></div>
                  <div id="locationSelect" class="btn btn-success">Select location</div>
                  <input type='hidden' name='lat'><input type='hidden' name='lng'>
                  <label style="margin-left:30px;margin-right: 3px;">Resolution*:</label>
                  <select class='medium' name='geom_basis' style="margin-top: 10px;">
                    <option value="" selected>&nbsp;</option>
                    {{#geom_bases}}
                    <option value="{{id}}">{{geom_basis}}</option>
                    {{/geom_bases}}
                  </select>
                  <input type='hidden' name='geom_basis_full'/>
                </td>
              </tr>
              <tr class="location_notes">
                <th class="right">Location notes:</th>
                <td><textarea class='span5' name='location_notes' placeholder='Add any notes about the collection location here'></textarea></td>
              </tr>
              <tr class="collector">
                <th class="right">Collector:</th>
                <td>
                  <select class="medium" name='collector'>
                    <option value="" selected>&nbsp;</option>
                    {{#people}}
                    <option value="{{id}}">{{name}}</option>
                    {{/people}}
                  </select>
                  <input type='hidden' name='collector_full'/>
                  <p class="addNewText">or enter a new one:</p><input type='text' size='12' name='new_collector_first_name' placeholder='First Name'/><input type='text' size='12' name='new_collector_last_name' placeholder='Last Name'/>
                </td>
              </tr>
              <tr class="collection_method">
                <th class="right">Collection Method:</th>
                <td>
                  <select class='medium' name='collection_method'>
                    <option value="" selected>&nbsp;</option>
                    {{#collection_methods}}
                    <option value="{{id}}">{{collection_method}}</option>
                    {{/collection_methods}}
                  </select>
                  <input type='hidden' name='collection_method_full'/>
                  <p class="addNewText">or enter a new one:</p><input type='text' size='22' name='new_collection_method'/>
                </td>
              </tr>
              <tr class="observed">
                <th class="right">Observed:</th>
                <td>Check box if specimen was observed but not collected <input type='checkbox' value='1' name='only_observed'></td>
              </tr>
              <tr class="bait_type">
                <th class="right">Bait Type:</th>
                <td>
                  <select class='medium' name='bait_type'>
                    <option value="" selected>&nbsp;</option>
                    {{#baits}}
                    <option value="{{id}}">{{bait}}</option>
                    {{/baits}}
                  </select>
                  <input type='hidden' name='bait_type_full'/>
                  <p class="addNewText">or enter a new one:</p><input type='text' size='22' name='new_bait_type'/>
                </td>
              </tr>
              <tr class="collection_media">
                <th class="right">Collection Media:</th>
                <td>
                  <select class='medium' name='collection_media'>
                    <option value="" selected>&nbsp;</option>
                    {{#collection_media}}
                    <option value="{{id}}">{{collection_medium}}</option>
                    {{/collection_media}}
                  </select>
                  <input type='hidden' name='collection_media_full'/>
                  <p class="addNewText">or enter a new one:</p><input type='text' size='22' name='new_collection_medium'/>
                </td>
              </tr>
              <tr class="environment">
                <th class="right">Collection environment:</th>
                <td>
                  <select class='medium' name='environment'>
                    <option value="" selected>&nbsp;</option>
                    {{#environments}}
                    <option value="{{id}}">{{environ}}</option>
                    {{/environments}}
                  </select>
                  <input type='hidden' name='environment_full'/>
                  <p class="addNewText">or enter a new one:</p><input type='text' size='22' name='new_environment'/><input type='text' size='22' name='new_environment_type' placeholder='Type (ex: lacustrine, coastal, landscape, etc...)'/><input type='text' size='22' name='new_environment_class' placeholder='Class (ex: aquatic, marine, paralic, etc...'/>
                </td>
              </tr>
              <tr class="totals">
                <th class="right">Individuals:</th>
                <td>
                  <select class='span1 totals' name='number_total'>
                    <option value="0" selected>0</option>
                  </select>

                  <label>Males:</label>
                  <select class='span1 totals' name='number_male'>
                    <option value="0" selected>0</option>
                  </select>

                  <label>Females:</label>
                  <select class='span1 totals' name='number_female'>
                    <option value="0" selected>0</option>
                  </select>
                </td>
              </tr>
              <tr class="notes">
                <th class="right">Notes:</th>
                <td><textarea class='span5' name='notes' placeholder='Occurence notes'></textarea></td>
              </tr>
              <hr>
              <tr class="image">
                <th class='right'>Image:</th>
                <td>
                  <!-- Save this in the event multiple photo uploads are needed 
                  <input type='file' name='filesToUpload' id='filesToUpload' style='display:none;' multiple='multiple'/> -->
                  <input type='file' name='filesToUpload' id='filesToUpload' style='display:none;' />

                  <div id="dropTarget">
                    <i class="icon-plus icon-4x" id="uploadPlus"></i><br>
                    <i id="uploadText">Click or drag image here</i>
                  </div>
                  <output id="selectedImages"></output>
                  <!--<label class="checkbox" style="display:inline-table;">
                    <input type='checkbox' name='watermark' value='1'/>Add copyright
                  </label>-->
                </td>
              </tr>
              <tr class="photographer">
                <th class="right">Photographer:</th>
                <td>
                  <select class="medium" name='photographer'>
                    <option value="" selected>&nbsp;</option>
                    {{#people}}
                    <option value="{{id}}">{{name}}</option>
                    {{/people}}
                  </select>
                  <input type='hidden' name='photographer_full'/>
                  <p class="addNewText">or enter a new one:</p><input type='text' size='12' name='new_photographer_first_name' placeholder='First Name'/><input type='text' size='12' name='new_photographer_last_name' placeholder='Last Name'/>
                </td>
                </td>
              </tr>
              <tr class="photo_description">
                <th class="right">Photo description:</th>
                <td><textarea class='span5' name='photo_description' placeholder='Photo description...'></textarea></td>
              </tr>
              <tr class="photo-date">
                <th class="right">Photo date:</th>
                <td>
                  <select class="span1" name="photoday"><option value="" selected>&nbsp;</option></select>
                  <select class="span2" name="photomonth">
                    <option value="" selected>&nbsp;</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                  </select>
                  <select class="span1" name="photoyear"><option value="" selected>&nbsp;</option></select>
                </td>
              </tr>
              <tr class="photo_location">
                <th class="right">Photo location:</th>
                <td>
                  <div id="selectedLocationPhoto" style="display: inline;margin-right: 10px;"></div>
                  <div id="locationSelectPhoto" class="btn btn-success">Select location</div>
                  <input type='hidden' name='photolat'><input type='hidden' name='photolng'>
                </td>
              </tr>
              <!--<tr class="photo-location-method">
                <th class="right">Photo location method:</th>
                <td>SELECT WITH geom_bases.geom_basis</td>
              </tr>-->
              
            </table>
            <p>* Required fields</p>
            <button type="submit" value="Submit" class="btn btn-success">Submit</button>
          </form>
        </div>
      </div>
    </div><!--/.fluid-container-->


    <div id="locationModal" class="modal modalImage hide fade">
      <div class="modal-body image">
        <ul id="tabs" class="nav nav-tabs" style="display:none;">
          <li class="active"><a href="#method" data-toggle="tab"><i class="icon-th"></i></a></li>
          <li><a href="#address" data-toggle="tab"><i class="icon-th"></i></a></li>
          <li><a href="#coordinates" data-toggle="tab"><i class="icon-picture"></i></a></li>
          <li><a href="#map" data-toggle="tab"></a></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane active" id="method">
            <div class="row-fluid">
              <div class="span4 locationMethod" id="coordinates">Enter coordinates<i class="icon-globe icon-3x"></i></div>
              <div class="span4 locationMethod" id="mapSelector">Select via map<i class="icon-map-marker icon-3x"></i></div>
              <div class="span4 locationMethod" id="address">Address, city, or county<i class="icon-home icon-3x"></i></div>
            </div>
          </div>
          <div class="tab-pane" id="address">
            <div class="modalBack"><i class="icon-arrow-left"></i> back</div>
            <div id="map1"></div>
          </div>

          <div class="tab-pane" id="coordinates">
            <div class="modalBack"><i class="icon-arrow-left"></i> back</div>
            <div id="map2"></div>
          </div>
          <div class="tab-pane" id="mapSelector">
            <div class="modalBack"><i class="icon-arrow-left"></i> back</div>
            <div id="map3"></div>
          </div>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Close &times;</button>
      </div>
    </div>

    {{#user}}
      <div id="currentUser" style="display:none;">{{name}}</div>
    {{/user}}

    <script src="/beetles/lib/jquery.v2.0.min.js"></script>
    <script src="/beetles/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="/beetles/lib/mustache.js"></script>
    <!--<script src="/lib/leaflet.js"></script>-->
    <script src="http://cdn.leafletjs.com/leaflet-0.6/leaflet.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script src="/beetles/lib/google.js"></script>

    <script type="text/javascript">

    $(document).ready(function() {
      resizeModal();
    });
    $(window).resize(function() {
      resizeModal();
    });

    var rank_hash =  { 26: 'informal', 25: 'unranked clade', 23: 'kingdom',
           22: 'subkingdom', 21: 'superphylum', 20: 'phylum', 19: 'subphylum',
           18: 'superclass', 17: 'class', 16: 'subclass', 15: 'infraclass',
           14: 'superorder', 13: 'order', 12: 'suborder', 11: 'infraorder',
           10: 'superfamily', 9: 'family', 8: 'subfamily', 7: 'tribe', 
           6: 'subtribe', 5: 'genus', 4: 'subgenus', 3: 'species', 2: 'subspecies'};

    var date = new Date(),
        today =  date.getMonth() + 1 + "-" + date.getDate() + "-" + date.getFullYear();

    $('#locationSelect').click(function() {
      referrer = 'location';
      $('#locationModal').modal('show');
    });

    $('#locationSelectPhoto').click(function() {
      referrer = 'photo';
      $('#locationModal').modal('show');
    });

    $('.locationMethod').click(function() {
      $('.tab-pane').removeClass('active');
      var theID = $(this).attr("id");
      $('#' + theID + '.tab-pane').addClass('active');
      map1.invalidateSize();
      map2.invalidateSize();
      map3.invalidateSize();
    });

    $('.modalBack').click(function() {
      $('.tab-pane').removeClass('active');
      $('#method.tab-pane').addClass('active');
    });

    function resizeModal() {
      var size = {width: $(window).width() , height: $(window).height() },
          offset = 20,
          offsetBody = 150;
      $('#locationModal').css('height', size.height - offset );
      $('.modal-body').css('height', size.height - offset - 56);
      $('#map3').css('height', size.height - offset - 60);
      $('#map2').css('height', size.height - offset - 60);
      $('#map1').css('height', size.height - offset - 60);
      $('#locationModal').css('top', 0);

      var childHeight = $('#method').height();
      $('#method').css('margin-top', ((size.height - offset) - childHeight) / 2);
    }

    // Fill the number of specimen selects. I don't want to write 100 lines of HTML manually
    for(var i=1;i<51;i++) {
      $('[name=number_male]').append('<option value="' + i + '">' + i + '</option>');
      $('[name=number_female]').append('<option value="' + i + '">' + i + '</option>');
      $('[name=number_total]').append('<option value="' + i + '">' + i + '</option>');
    }

    // Fill in the calendars
    for (var i=1; i<32; i++) {
      if (i < 10) {
        $('[name=daystart]').append('<option value="0' + i + '">' + i + '</option>');
        $('[name=dayend]').append('<option value="0' + i + '">' + i + '</option>');
        $('[name=photoday]').append('<option value="0' + i + '">' + i + '</option>');
      } else {
        $('[name=daystart]').append('<option value="' + i + '">' + i + '</option>');
        $('[name=dayend]').append('<option value="' + i + '">' + i + '</option>');
        $('[name=photoday]').append('<option value="' + i + '">' + i + '</option>');
      }
      
    }
    for (var i=date.getFullYear(); i>1900; i--) {
      $('[name=yearstart]').append('<option value="' + i + '">' + i + '</option>');
      $('[name=yearend]').append('<option value="' + i + '">' + i + '</option>');
      $('[name=photoyear]').append('<option value="' + i + '">' + i + '</option>');
    }

    // Initialize the map
    var map1 = new L.Map('map1', {
      center: new L.LatLng(40.2, -82.9),
      zoom: 7,
      minZoom: 7,
      zoomControl: true,
      zoomAnimation: false
    });

    var roads1 = new L.Google('ROADMAP'),
        sat1 = new L.Google('HYBRID');

    map1.addLayer(roads1);

    var basemaps1 = {
      "Roads": roads1,
      "Satellite": sat1
    };

    var toggler = L.control.layers(basemaps1, {}, {position:'bottomleft'}).addTo(map1);

    var mapInstructions1 = L.control({position: 'topright'});

    mapInstructions1.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'mapInstructions');
        div.innerHTML += '<p><i>Enter an address below. <br> Drag the marker to adjust the location</i></p><input class="span3" id="address" placeholder="Ex: 1739 N High St, Columbus, Ohio" style="margin-right:4px;"><div id="viewOnMap1" class="btn btn-inverse">View on map</div><br><div id="map1SelectDone" class="btn btn-success">Done</div>';
        return div;
    };

    mapInstructions1.addTo(map1);

    // Initialize the map
    var map2 = new L.Map('map2', {
      center: new L.LatLng(40.2, -82.9),
      zoom: 7,
      minZoom: 7,
      zoomControl: true,
      zoomAnimation: false
    });

    var roads2 = new L.Google('ROADMAP'),
        sat2 = new L.Google('HYBRID');

    map2.addLayer(roads2);

    var basemaps2 = {
      "Roads": roads2,
      "Satellite": sat2
    };

    var toggler = L.control.layers(basemaps2, {}, {position:'bottomleft'}).addTo(map2);

    var mapInstructions2 = L.control({position: 'topright'});


    mapInstructions2.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'mapInstructions');
        div.innerHTML += '<p><i>Select a coordinate format, and then enter them below. <br> Drag the marker to adjust the location</i></p><label class="radio inline"><input type="radio" name="llType" value="dd" checked>DD</label><label class="radio inline"><input type="radio" name="llType" value="dm">DM</label><label class="radio inline"><input type="radio" name="llType" value="dms">DMS</label><div class="row"><div class="span2" id="coordHolder"><input class="span2" id="lat" placeholder="Latitude (ex: 39.9613)" type="text"><input class="span2" id="lng" placeholder="Longitude (ex: -82.9991)" type="text"></div><div class="span2"><div id="viewOnMap" class="btn btn-inverse">View on map</div><br><div id="map2SelectDone" class="btn btn-success">Done</div></div></div>';
        return div;
    };

    mapInstructions2.addTo(map2);

    $("input[name=llType]").change(function() {

      var type = $("input[name=llType]:checked").val();

      if (type === "dd") {
        var html = '<input class="span2" id="lat" placeholder="Latitude (ex: 39.9613)" type="text"><input class="span2" id="lng" placeholder="Longitude (ex: -82.9991)" type="text">';
        $("#coordHolder").html(html);
      } else if (type === "dm") {
        var html = '<input id="degreesLat" placeholder="Lat. D" type="text"><input id="minutesLat" placeholder="Lat. Minutes" type="text"><br><input id="degreesLng" placeholder="Lng. D" type="text"><input id="minutesLng" placeholder="Lng. Minutes" type="text">';
        $("#coordHolder").html(html);
      } else {
        var html = '<input id="degreesLat" placeholder="DD" type="text" style="width:25px;"><input id="minutesLat" placeholder="MM" type="text" style="width:25px;"><input id="secondsLat" placeholder="SS" type="text" style="width:25px;"><br><input id="degreesLng" placeholder="DD" type="text" style="width:25px;"><input id="minutesLng" placeholder="MM" type="text" style="width:25px;"><input id="secondsLng" placeholder="SS" type="text" style="width:25px;">';
        $("#coordHolder").html(html);
      }
    });

    // Initialize the map
    var map3 = new L.Map('map3', {
      center: new L.LatLng(40.2, -82.9),
      zoom: 7,
      minZoom: 7,
      zoomControl: true,
      zoomAnimation: false
    });

    var roads3 = new L.Google('ROADMAP'),
        sat3 = new L.Google('HYBRID');

    map3.addLayer(roads3);

    var basemaps3 = {
      "Roads": roads3,
      "Satellite": sat3
    };

    var toggler = L.control.layers(basemaps3, {}, {position:'bottomleft'}).addTo(map3);

    var mapInstructions = L.control({position: 'topright'});

    mapInstructions.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'mapInstructions');
        div.innerHTML += '<p><i>Click on the map to add a marker.<br> Drag the marker to the desired location</i></p><div id="map3SelectDone" class="btn btn-success">Done</div>';
        return div;
    };

    mapInstructions.addTo(map3);

    map3.on('click', function(e) {
      if (Object.keys(map3._layers).length < 2) {
        marker3 = new L.Marker([e.latlng.lat, e.latlng.lng], {
          draggable:true
        });
        map3.addLayer(marker3);
        map3.setView([e.latlng.lat, e.latlng.lng], 10);
      }
    });

    $('#map3SelectDone').click(function() {
      try {
        var markerCoords = marker3.getLatLng();
      } catch(e) {
        return alert("Please verify the coordinates by selecting 'View on Map'");
      }

      var occurrenceLocation = [markerCoords.lat, markerCoords.lng];

      $('#locationModal').modal('hide');
      
      if (referrer == 'location') {
        $('#selectedLocation').html("Location selected: " + occurrenceLocation[0].toFixed(4) + ", " + occurrenceLocation[1].toFixed(4));
        $('[name=lat]').val(occurrenceLocation[0].toFixed(4));
        $('[name=lng]').val(occurrenceLocation[1].toFixed(4));
      } else {
        $('#selectedLocationPhoto').html("Location selected: " + occurrenceLocation[0].toFixed(4) + ", " + occurrenceLocation[1].toFixed(4));
        $('[name=photolat]').val(occurrenceLocation[0].toFixed(4));
        $('[name=photolng]').val(occurrenceLocation[1].toFixed(4));
      }
      
    });

    $('#map2SelectDone').click(function() {
      try {
        var markerCoords = marker2.getLatLng();
      } catch(e) {
        return alert("Please verify the coordinates by selecting 'View on Map'");
      }

      var occurrenceLocation = [markerCoords.lat, markerCoords.lng];

      $('#locationModal').modal('hide');

      if (referrer == 'location') {
        $('#selectedLocation').html("Location selected: " + occurrenceLocation[0].toFixed(4) + ", " + occurrenceLocation[1].toFixed(4));
        $('[name=lat]').val(occurrenceLocation[0].toFixed(4));
        $('[name=lng]').val(occurrenceLocation[1].toFixed(4));
      } else {
        $('#selectedLocationPhoto').html("Location selected: " + occurrenceLocation[0].toFixed(4) + ", " + occurrenceLocation[1].toFixed(4));
        $('[name=photolat]').val(occurrenceLocation[0].toFixed(4));
        $('[name=photolng]').val(occurrenceLocation[1].toFixed(4));
      }
    });

    $('#viewOnMap').click(function() {
      var llFormat = $("#llType").val();

      if (llFormat === "dd") {
        var lat = $('#lat').val(),
            lng = $('#lng').val();
      } else if (llFormat === "dm") {
        // convert from DD MM.mmm here
        var degreesLat = parseFloat($("#degreesLat").val()),
            minutesLat = parseFloat($("#minutesLat").val()),

            degreesLng = parseFloat($("#degreesLng").val()),
            minutesLng = parseFloat($("#minutesLng").val());

        var lat = degreesLat + (minutesLat/60),
            lng = degreesLng + (minutesLng/60);
 
      } else {
        // convert from DMS here
        var degreesLat = parseFloat($("#degreesLat").val()),
            minutesLat = parseFloat($("#minutesLat").val()),
            secondsLat = parseFloat($("#secondsLat").val()),

            degreesLng = parseFloat($("#degreesLng").val()),
            minutesLng = parseFloat($("#minutesLng").val()),
            secondsLng = parseFloat($("#secondsLng").val());

        var lat = degreesLat + (minutesLat/60) + (secondsLat/3600),
            lng = degreesLng + (minutesLng/60) + (secondsLng/3600);

      }

      if (Object.keys(map2._layers).length < 2) {

        marker2 = new L.Marker([lat, lng], {
          draggable: true
        }).addTo(map2);

        marker2.on('dragend', function() {
          var latlng = marker2.getLatLng();
          $('#lat').val(latlng.lat.toFixed(5));
          $('#lng').val(latlng.lng.toFixed(5));
        });

        map2.panTo([lat,lng]);

        if (map2.getZoom() < 11) {
          map2.setZoom(14);
        } 

      } else {
        marker2.setLatLng([lat, lng]);
        map2.panTo([lat,lng]);
      }
      
    });

    $('#viewOnMap1').click(function() {
      var address = $('#address.span3').val();
      $.ajax({
        type:'GET',
        url:'http://maps.googleapis.com/maps/api/geocode/json?address=' + encodeURIComponent(address) + '&sensor=false',
        dataType: 'json', 
        async: false,
        success: function(data) {
          var lat = data.results[0].geometry.location.lat,
              lng = data.results[0].geometry.location.lng;

          if (Object.keys(map1._layers).length < 2) {
            marker1 = new L.Marker([lat, lng], {
              draggable: true
            }).addTo(map1);

            map1.panTo([lat,lng]);
            map1.setZoom(14);
          } else {
            marker1.setLatLng([lat, lng]);
            map1.panTo([lat,lng]);
          }
        }
      });
    });

    $('#map1SelectDone').click(function() {
      try {
        var markerCoords = marker1.getLatLng();
      } catch(e) {
        return alert("Please verify the coordinates by selecting 'View on Map'");
      }

      var occurrenceLocation = [markerCoords.lat, markerCoords.lng];

      $('#locationModal').modal('hide');

      if (referrer == 'location') {
        $('#selectedLocation').html("Location selected: " + occurrenceLocation[0].toFixed(4) + ", " + occurrenceLocation[1].toFixed(4));
        $('[name=lat]').val(occurrenceLocation[0].toFixed(4));
        $('[name=lng]').val(occurrenceLocation[1].toFixed(4));
      } else {
        $('#selectedLocationPhoto').html("Location selected: " + occurrenceLocation[0].toFixed(4) + ", " + occurrenceLocation[1].toFixed(4));
        $('[name=photolat]').val(occurrenceLocation[0].toFixed(4));
        $('[name=photolng]').val(occurrenceLocation[1].toFixed(4));
      }
    });

    if ($('#currentUser').html().length > 0) {
      var options = $('option');
      for (var i=0; i<options.length; i++) {
        if($(options[i]).html() == $('#currentUser').html()) {
          $(options[i]).prop("selected", true);
        }
      }
    }

    function fileSelect(evt) {
      // If user clicked to upload a picture
      if (evt.type == 'change') {
        var files = evt.target.files;
      // If user drags a picture to upload
      } else {
        ignoreDrag(evt);
        var target = evt.originalEvent.dataTransfer,
            files = target.files;
      }

      var result = '',
          file;

      // Loop through the files
      for (var i=0; file = files[i]; i++) {
        // if the file is not an image, continue
        if (!file.type.match('image.*')) {
            continue;
        }

        var reader = new FileReader();
        reader.onload = (function() {
          return function(evt) {
            // This checks the dimensions of the image
            var img = new Image;
            img.onload = function() {
              if (img.width > img.height) {
                width = '160';
                $('#selectedImages').html('<img class="imagesToUpload" style="width: ' + width + 'px;" src="' + evt.target.result + '" />');
              } else {
                width = '90';
                $('#selectedImages').html('<img class="imagesToUpload" style="width: ' + width + 'px;" src="' + evt.target.result + '" />');
              }
            }
            img.src = evt.target.result; 
          }
        }(file));
        reader.readAsDataURL(file);
      }
    }
   
    $('#filesToUpload').on('change', fileSelect);

    $('#dropTarget').click(function() {
      $('input[type=file]').click();
    });
    
    $('#dropTarget')
      .bind('dragenter', ignoreDrag)
      .bind('dragover', ignoreDrag)
      .bind('drop', fileSelect);

    function ignoreDrag(e) {
      e.originalEvent.stopPropagation();
      e.originalEvent.preventDefault();
    }

    $('[name=family]')
        .typeahead({
          minLength: 2,
          source: getFamilies(),
          // Match only the beginning of words
          matcher: function (item) {
            if (item.toLowerCase().indexOf(this.query.toLowerCase()) == 0) {
              return ~item.toLowerCase().indexOf(this.query.toLowerCase());
            } 
          }
        });

    $('[name=family], [name=genus], [name=species]').change(function() {
      if ($(this).attr('name') == 'family') {
        var family = $('[name=family]').val(),
            genera = [];

        $.ajax({
          type:'GET',
          url:'http://paleobiodb.org/data1.1/taxa/list.json?name=' + family + '&rel=synonyms&extant=true&show=attr',
          dataType: 'json', 
          async: false,
          success: function(data) {
            var results = data.records;
            
            if (results[0].att) {
              for (var i=0; i<results.length; i++) {
                if (rank_hash[results[i].rnk] == 'genus') {
                  genera.push(results[i].nam);
                }
              }

              if (results[0].nm2) {
                $('[name=common_name]').val(results[0].nm2);
              }

              $('[name=author]').val(results[0].att);
              $('[name=pbdb_family_no]').val(results[0].oid);

              $('[name=genus]')
                .typeahead({
                  minLength: 2,
                  source: genera,
                  // Match only the beginning of words
                  matcher: function (item) {
                    if (item.toLowerCase().indexOf(this.query.toLowerCase()) == 0) {
                      return ~item.toLowerCase().indexOf(this.query.toLowerCase());
                    } 
                  }
                });

              console.log(genera);
            } else {
              alert("Family not found in PaleoDB. Please make sure the spelling is correct before continuing");
            }
          } 
        }); // End family verify ajax
      } // End if Family
      else if ($(this).attr('name') == 'genus') {
        var genus = $('[name=genus]').val(),
            species = [],
            family = '';

        $.ajax({
          type:'GET',
          url:'http://paleobiodb.org/data1.1/taxa/list.json?name=' + genus + '&rel=synonyms&extant=true&show=attr', 
          dataType: 'json', 
          async: false,
          success: function(data) {
            var results = data.records;
            for (var i=0; i<results.length; i++) {
              if (rank_hash[results[i].rnk] == 'species') {
                var item = results[i].nam;
                item = item.split(" ");
                species.push(item[1]);
              }
              if (rank_hash[results[i].rnk] == 'genus') {
                if (results[i].nm2) {
                  $('[name=common_name]').val(results[i].nm2);
                }
              }              
            }

            $('[name=author]').val(results[0].att);
            $('[name=pbdb_genus_no]').val(results[0].oid);

            $('[name=species]')
              .typeahead({
                minLength: 2,
                source: species,
                // Match only the beginning of words
                matcher: function (item) {
                  if (item.toLowerCase().indexOf(this.query.toLowerCase()) == 0) {
                    return ~item.toLowerCase().indexOf(this.query.toLowerCase());
                  } 
                }
              });

            console.log(species);
          } 
        }); // End genus verify ajax
        
        // Fill in the family
        $.ajax({
          type:'GET',
          url:'http://paleobiodb.org/data1.1/taxa/list.json?name=' + genus + '&rel=all_parents&rank=family',
          dataType: 'json', 
          async: false,
          success: function(data) {
            var results = data.records;
            console.log(data);
            for (var i=0; i<results.length; i++) {
              if (rank_hash[results[i].rnk] == 'family') {
                $('[name=family]').val(results[i].nam);
                $('[name=pbdb_family_no]').val(results[i].oid);
                if (results[i].nm2) {
                  $('[name=common_name]').val(results[i].nm2);
                }
              } 
            }
          } 
        });

      } // End if Genus
      else if ($(this).attr('name') == 'species') {
        var species = $('[name=species]').val();
        $.ajax({
          type:'GET',
          url:'http://paleobiodb.org/data1.1/taxa/list.json?name=' + species + '&rel=synonyms&extant=true&show=attr', 
          dataType: 'json', 
          async: false,
          success: function(data) {
            var results = data.records;

            if (results[0].nm2) {
              $('[name=common_name]').val(results[0].nm2);
            }

            $('[name=author]').val(results[0].att);
            $('[name=pbdb_species_no]').val(results[0].oid);

          } 
        }); // End species ajax
      }
    });
  
    function getFamilies() {
      var families = []; 
      $.ajax({
        type:'GET',
        url:'http://paleobiodb.org/data1.1/taxa/list.json?name=Coleoptera&rel=all_children&extant=true&rank=family', 
        dataType: 'json', 
        async: false,
        success: function(data) {
          var results = data.records;
          for (var i=0; i<results.length; i++) {
            if (rank_hash[results[i].rnk] == 'family') {
              families.push(results[i].nam);
            } 
          }
        } 
      });
      return families;
    }

    // record the full text value of the selects in hidden inputs for use on the success page
    $('[name=photographer], [name=collector], [name=collection_method], [name=bait_type], [name=collection_media], [name=environment], [name=geom_basis], [name=determiner]').change(function() {
      var name = $(this).attr('name'),
          full_text = $('[name=' + name + '] option:selected').text();
      $('[name=' + name + '_full]').val(full_text);
    });

    $('[name=photographer_full]').val($('[name=photographer] option:selected').text());
    $('[name=collector_full]').val($('[name=collector] option:selected').text());
    $('[name=collection_method_full]').val($('[name=collection_method] option:selected').text());
    $('[name=bait_type_full]').val($('[name=bait_type] option:selected').text());
    $('[name=collection_media_full]').val($('[name=collection_media] option:selected').text());
    $('[name=environment_full]').val($('[name=environment] option:selected').text());
    $('[name=geom_basis_full]').val($('[name=geom_basis] option:selected').text());
    $('[name=determiner_full]').val($('[name=determiner] option:selected').text());
    
    /*
    TODO: Make sure that the taxon items match the PaleoDB number assigned - they could in theory select an item which will autofill the PaleoDB number, and then change it which wouldn't change the PaleoDB number
    */

    function validate() {
      var family = $('[name=family]').val(),
          collection_date = $('[name=collection_date_start]').val(),
          lat = $('[name=lat]').val(),
          geom_basis = $('[name=geom_basis]').val();

      if (family.length < 1) {
        $("#familyGroup").addClass("error");
        alert("Please enter a valid taxon family");
        return false;
      } else {
        // Double check family
        $.ajax({
            type:'GET',
            url:'http://paleobiodb.org/data1.1/taxa/list.json?name=' + family + '&rel=synonyms&extant=true&show=attr', 
            dataType: 'json', 
            async: false,
            success: function(data) {
              var results = data.records;
              if (results.length > 1) {
                $('#familyGroup').addClass("success");
                return true;
              } else {
                $("#familyGroup").addClass("error");
                alert("Family not found in PaleoDB. Please make sure the spelling is correct before continuing");
                return false;
              }
            } 
          }); // End family verify ajax
      }


/* FIXME
      if (collection_date.length < 10) {
        $('#collection_date_row').css('border', '2px solid red');
        alert("Please enter a valid collection date");
        return false;
      } else if (lat.length < 2) {
        $('#collection_date_row').css('border', 'none');
        $('.location').css('border', '2px solid red');
        alert("Please enter a valid location");
        return false;
      } else if (geom_basis.length < 1) {
        $('.location').css('border', '2px solid red');
        alert("Please enter a valid location resolution");
        return false;
      } else {
        return true;
      }
*/
    } // end function validate
    </script>

  </body>
</html>